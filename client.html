<html>
<head>
<link href='http://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
<style>
#wrapper {
  width: 900px;
  position: absolute;
  top: 0px;
  left: 0px;
  height: auto;
  border: 1px;
  border-style: solid;
}

#titleDiv {
  position: relative;
  top: 0px;
  left: 0px;
  width: 900px;
  height: auto;
  background-color: rgb(44, 62, 80);
  display: inline-block;
}

#title {
  font-family: 'Lato';
  color: white;
  padding-left: 20px;
}

#playDiv {
  position: relative;
  top: 0px;
  left: 0px;
  width: 900px;
  height: auto;
  background-color: white;
  display: inline-block;
}

#player3 {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: auto;
  font-family: 'Lato';
  color: black;
  text-align: center;
  display: inline-block;
  padding-top: 10px;
  padding-bottom: 10px;
}

#player2 {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: auto;
  font-family: 'Lato';
  color: black;
  text-align: center;
  display: inline-block;
  padding-top: 10px;
  padding-bottom: 10px;
}

#player4 {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: auto;
  font-family: 'Lato';
  color: black;
  text-align: center;
  display: inline-block;
  padding-top: 10px;
  padding-bottom: 10px;
}

#player5 {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: auto;
  font-family: 'Lato';
  color: black;
  text-align: center;
  display: inline-block;
  padding-top: 10px;
  padding-bottom: 10px;
}

#player1 {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: auto;
  font-family: 'Lato';
  color: black;
  text-align: center;
  display: inline-block;
  padding-top: 10px;
  padding-bottom: 10px;
}

#status {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: auto;
  min-height: 50px;
  display: inline-block;
  font-family: 'Lato';
  color: black;
  text-align: center;
}

#playedArea {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: auto;
  min-height: 150px;
  text-align: center;
  font-family: 'Lato';
  color: black;
  display: inline-block;
}

#discardArea {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: auto;
  min-height: 150px;
  text-align: center;
  font-family: 'Lato';
  color: black;
  display: inline-block;
}

#card1 {
  width: auto;
  height: auto;
  border: 1px;
  border-style: solid;
  display: inline-block;
}

#card2 {
  width: auto;
  height: auto;
  border: 1px;
  border-style: solid;
  display: inline-block;
}

#card3 {
  width: auto;
  height: auto;
  border: 1px;
  border-style: solid;
  display: inline-block;
}

#card4 {
  width: auto;
  height: auto;
  border: 1px;
  border-style: solid;
  display: inline-block;
}

#column1 {
  float: left;
  width: 300px;
  height: auto;
}

#column2 {
  float: right;
  width: 600px;
  height: auto;
}

#column2a {
  float: left;
  width: 300px;
  height: auto;
}

#column2b {
  float: right;
  width: 300px;
  height: auto;
}

#chat {
  position: relative;
  top: 0px;
  left: 0px;
  width: 300px;
  height: 100px;
  min-height: 100px;
  display: inline-block;
  font-family: 'Lato';
  color: black;
  overflow: scroll;
}

</style>
</head>

<body>
<div id="wrapper">
<div id="titleDiv"><h2 id="title">Fireworks!</h2></div>

<div id="playDiv">

<div id="column1">

<div id="chat">chat</div>

<div id="player3">
<div id="name">waiting for player3</div>
<div id="card1"></div>
<div id="card2"></div>
<div id="card3"></div>
<div id="card4"></div>
</br>
<div id="hints"></div>
</div>

<div id="player2">
<div id="name">waiting for player2</div>
<div id="card1"></div>
<div id="card2"></div>
<div id="card3"></div>
<div id="card4"></div>
</br>
<div id="hints"></div>
</div>

</div>
<div id="column2">

<div id="column2a">

<div id="status">status</div>
<div id="playedArea">playedArea</div>
<div id="discardArea">discardArea</div>

<div id="player1">
<div id="name">waiting for player1</div>
<div id="card1"></div>
<div id="card2"></div>
<div id="card3"></div>
<div id="card4"></div>
</br>
<button id="rearrange">Rearrange</button>
<button id="rearrangeOk" hidden="true">Ok</button>
<button id="rearrangeCancel" hidden="true">Cancel</button></br>
<button id="discard">Discard</button></br>
<button id="play">Play</button>
</div>

</div>
<div id="column2b">

<div id="player4">
<div id="name">waiting for player4</div>
<div id="card1"></div>
<div id="card2"></div>
<div id="card3"></div>
<div id="card4"></div>
</br>
<div id="hints"></div>
</div>

<div id="player5">
<div id="name">waiting for player5</div>
<div id="card1"></div>
<div id="card2"></div>
<div id="card3"></div>
<div id="card4"></div>
</br>
<div id="hints"></div>
</div>

</div>
</div>




</div>
</div>
<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
  var socket = io();

  var socketid = ''

  var playerName = prompt("enter your player's name:")
  if (playerName != null) {
    socket.emit('name', playerName)
  }
 
  socket.on('idnotice', function(msg) {
    socketid = msg
  })

  socket.on('gameover', function(msg) {
    alert('game over! total score: ' + msg + '\nrefresh page to play new game')
    $('#rearrange').attr('disabled', true)
    $('#discard').attr('disabled', true)
    $('#play').attr('disabled', true)
    $('#hints button').attr('disabled', true)
  })

  socket.on('chat', function(msg) {
    var html = $('#chat').html()
    html +=  '<li>' + msg + '</li>'
    $('#chat').html(html)
    $('#chat').animate({
      "scrollTop": $('#chat')[0].scrollHeight
    }, 300)
  })

  var colors = ["rgb(41,128,185)", "rgb(39,174,96)", "rgb(241,196,15)", "rgb(192,57,43)", "rgb(142,68,173)"];
  var colorNames = ["blue", "green", "yellow", "red", "purple"]

  function getCardSvg(card) {
    var color = colors[card.color];
    var num = card.num;
    return "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"80\"><g><rect x=\"0\" y=\"0\" width=\"50\" height=\"80\" fill=" + color + " style=\"stroke-width:3;stroke:rgb(0,0,0)\"></rect><text x=\"25\" y=\"40\" font-family=\"Verdana\" font-size=\"20\" fill=\"black\">" + num + "</text></g></svg>";
  }

  function getCardSvgByColor(color) {
    return "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"80\"><g><rect x=\"0\" y=\"0\" width=\"50\" height=\"80\" fill=" + color + " style=\"stroke-width:3;stroke:rgb(0,0,0)\"></rect><text x=\"25\" y=\"40\" font-family=\"Verdana\" font-size=\"20\" fill=\"black\"></text></g></svg>";
  }


  function sendHint(msg) {
    socket.emit('hint', msg)
  }

  socket.on('currentMove', function(msg) {
    if (msg == socketid) {
      //current player's move
      $('#discard').attr('disabled', false)
      $('#play').attr('disabled', false)
      $('#hints button').attr('disabled', false)
    } else {
      $('#discard').attr('disabled', true)
      $('#play').attr('disabled', true)
      $('#hints button').attr('disabled', true)

    }
  })

  socket.on('cards', function(cards) {
    //alert('data - ' + JSON.stringify(cards))

    var idx=-1

    for(var i=0; i<cards.length; i++) {
      if (cards[i].id == socketid) {
        idx=i
      }
    }

    if (idx==-1) {
      return
    }

    cards = cards.concat(cards.splice(idx, cards.length-idx),cards.splice(0, idx))
    //alert('socketid:'+socketid+';'+JSON.stringify(cards))

    for(var i=0; i<cards.length; i++) {
      if (i==0) {
        $('#player' + (i+1) + ' #name').html('You (' + cards[i].name + ')</br></br>');
      } else {
        $('#player' + (i+1) + ' #name').html('Player (' + cards[i].name + ')</br></br>');
      }
      if (cards[i].move == true) {
        $('#player' + (i+1)).css('background-color', 'yellow')
      } else {
        $('#player' + (i+1)).css('background-color', 'white')
      }
      for(var j=0; j<cards[i].cards.length; j++) {
        $('#player' + (i+1) + ' #card' + (j+1)).html(function () {
          var html = '';
          if (j==0) {
            html += '1st';
          } else if (j==1) {
            html += '2nd';
          } else if (j==2) {
            html += '3rd';
          } else {
            html += '4th';
          }
          html += '</br>';
          if (cards[i].cards[j] == null) {
            html += getCardSvgByColor('white')
          } else if (i == 0) {
            html += getCardSvg({color: -1, num: '?'});
          } else {
            html += getCardSvg(cards[i].cards[j]);
          }
          html += '';
          return html;
        });
      }
    } 

    for(var i=0; i<cards.length; i++) {
      var colorIdx = [[], [], [], [], []];
      var numIdx = [[], [], [], [], []];
      var playerName = cards[i].name
      for(var j=0; j<cards[i].cards.length; j++) {
        if (cards[i].cards[j] != null) {
          var color = cards[i].cards[j].color;
          var num = cards[i].cards[j].num;
          var cIdx = colorIdx[color].length;
          colorIdx[color][cIdx] = j+1;
          var nIdx = numIdx[num-1].length;
          numIdx[num-1][nIdx] = j+1;
        }
      }
      $('#player' + (i+1) + ' #hints').html('</br>')
      for(var k=0; k<colorIdx.length; k++) {
        if (colorIdx[k].length > 0) {
          $('#player' + (i+1) + ' #hints').html(function() {
            var name = 'card ' + colorIdx[k] + ' is color ' + colorNames[k];
            return $('#player' + (i+1) + ' #hints').html() + '<button onclick=\"sendHint(\'' + playerName + ', your ' + name + '\')\">' + name + '</button></br>';
          })
        }
      }
      
      for(var k=0; k<numIdx.length; k++) {
        if (numIdx[k].length > 0) {
          $('#player' + (i+1) + ' #hints').html(function() {
            var name = 'card ' + numIdx[k] + ' is number ' + (k+1);
            return $('#player' + (i+1) + ' #hints').html() + '<button onclick=\"sendHint(\'' + playerName + ', your ' + name + '\')\">' + name + '</button></br>';
          })
        }
      }
    }

    $('#player1 #rearrange').click(function() {
      $('#hints button').attr("disabled", true)
      $('#discard').attr("disabled", true)
      $('#play').attr("disabled", true)
      //$('#player1 #rearrange').attr("hidden", true)
      $('#player1 #rearrangeOk').attr("hidden", true)
      $('#player1 #rearrangeCancel').attr("hidden", true)
      rearrangedCards = []
      for (var j=0; j<cards[0].cards.length; j++) {
        $('#player1 #card' + (j+1)).html(function () {
          var html = '&nbsp;';
          html += '</br>';
          if (cards[0].cards[j] == null) {
            html += getCardSvgByColor('white')
          } else {
            html += getCardSvg({color: -1, num: '?'});
          }
          return html;
        });
      }
    })

    $('#player1 #rearrangeOk').click(function() {
      $('#hints button').attr("disabled", false)
      $('#discard').attr("disabled", false)
      $('#play').attr("disabled", false)
      $('#player1 #rearrange').attr("hidden", false)
      $('#player1 #rearrangeOk').attr("hidden", true)
      $('#player1 #rearrangeCancel').attr("hidden", true)
    })

    $('#player1 #rearrangeCancel').click(function() {
      $('#hints button').attr("disabled", false)
      $('#discard').attr("disabled", false)
      $('#play').attr("disabled", false)
      $('#player1 #rearrange').attr("hidden", false)
      $('#player1 #rearrangeOk').attr("hidden", true)
      $('#player1 #rearrangeCancel').attr("hidden", true)
    })

    $('#player1 #discard').click(function() {
      $('#hints button').attr("disabled", true)
      $('#discard').attr("disabled", false)
      $('#play').attr("disabled", true)
      $('#player1 #rearrange').attr("disabled", true)
    })

    $('#player1 #play').click(function() {
      $('#hints button').attr("disabled", true)
      $('#discard').attr("disabled", true)
      $('#play').attr("disabled", false)
      $('#player1 #rearrange').attr("disabled", true)
    })

    var rearrangedCards = []

    $('#player1 #card1').click(function() {
      var discardInPlay = $('#discard').attr('disabled')
      var playInPlay = $('#play').attr('disabled')
      var rearrangeInPlay = $('#rearrange').attr('disabled')
      if (discardInPlay == 'disabled' && playInPlay == 'disabled') {
        var idx = rearrangedCards.length
        rearrangedCards[idx] = 0
        $('#player1 #card1').html(function () {
          var html = ''
          if (idx==0) {
            html += '1st';
          } else if (idx ==1) {
            html += '2nd';
          } else if (idx ==2) {
            html += '3rd';
          } else {
            html += '4th';
          }
          html += '</br>'
          html += getCardSvg({color: -1, num: '?'});
          html += '';
          return html
        })
        $('#player1 #card1').off('click')
        if (rearrangedCards.length == cards[0].cards.length) {
          socket.emit('rearrange', rearrangedCards)
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
          rearrangedCards = []
        }
      } else if (cards[0].cards[0] != null) {
        if (rearrangeInPlay == 'disabled' && playInPlay == 'disabled') {
          socket.emit('discard', '0')
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
        } else if (rearrangeInPlay == 'disabled' && discardInPlay == 'disabled') {
          socket.emit('play', '0')
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
        }
      }
    })

    $('#player1 #card2').click(function() {
      var discardInPlay = $('#discard').attr('disabled')
      var playInPlay = $('#play').attr('disabled')
      var rearrangeInPlay = $('#rearrange').attr('disabled')
      if (discardInPlay == 'disabled' && playInPlay == 'disabled') {
        var idx = rearrangedCards.length
        rearrangedCards[idx] = 1
        $('#player1 #card2').html(function () {
          var html = ''
          if (idx==0) {
            html += '1st';
          } else if (idx ==1) {
            html += '2nd';
          } else if (idx ==2) {
            html += '3rd';
          } else {
            html += '4th';
          }
          html += '</br>'
          html += getCardSvg({color: -1, num: '?'});
          html += '';
          return html
        })
        $('#player1 #card2').off('click')
        if (rearrangedCards.length == cards[0].cards.length) {
          socket.emit('rearrange', rearrangedCards)
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("hidden", false)
          rearrangedCards = []
        } 
      } else if (cards[0].cards[1] != null) {
        if (rearrangeInPlay == 'disabled' && playInPlay == 'disabled') {
          socket.emit('discard', '1')
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
        } else if (rearrangeInPlay == 'disabled' && discardInPlay == 'disabled') {
          socket.emit('play', '1')
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
        }
      }
    }) 

    $('#player1 #card3').click(function() {
      var discardInPlay = $('#discard').attr('disabled')
      var playInPlay = $('#play').attr('disabled')
      var rearrangeInPlay = $('#rearrange').attr('disabled')
      if (discardInPlay == 'disabled' && playInPlay == 'disabled') {
        var idx = rearrangedCards.length
        rearrangedCards[idx] = 2
        $('#player1 #card3').html(function () {
          var html = ''
          if (idx==0) {
            html += '1st';
          } else if (idx ==1) {
            html += '2nd';
          } else if (idx ==2) {
            html += '3rd';
          } else {
            html += '4th';
          }
          html += '</br>'
          html += getCardSvg({color: -1, num: '?'});
          html += '';
          return html
        })
        $('#player1 #card3').off('click')
        if (rearrangedCards.length == cards[0].cards.length) {
          socket.emit('rearrange', rearrangedCards)
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("hidden", false)
          rearrangedCards = []
        }
      } else if(cards[0].cards[2] != null) {
        if (rearrangeInPlay == 'disabled' && playInPlay == 'disabled') {
          socket.emit('discard', '2')
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
        } else if (rearrangeInPlay == 'disabled' && discardInPlay == 'disabled') {
          socket.emit('play', '2')
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
        }
      }
    })

    $('#player1 #card4').click(function() {
      var discardInPlay = $('#discard').attr('disabled')
      var playInPlay = $('#play').attr('disabled')
      var rearrangeInPlay = $('#rearrange').attr('disabled')
      if (discardInPlay == 'disabled' && playInPlay == 'disabled') {
        var idx = rearrangedCards.length
        rearrangedCards[idx] = 3
        $('#player1 #card4').html(function () {
          var html = ''
          if (idx==0) {
            html += '1st';
          } else if (idx ==1) {
            html += '2nd';
          } else if (idx ==2) {
            html += '3rd';
          } else {
            html += '4th';
          }
          html += '</br>'
          html += getCardSvg({color: -1, num: '?'});
          html += '';
          return html
        })
        $('#player1 #card4').off('click')
        if (rearrangedCards.length == cards[0].cards.length) {
          socket.emit('rearrange', rearrangedCards)
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("hidden", false)
          rearrangedCards = []
        }
      } else if (cards[0].cards[3] != null) {
        if (rearrangeInPlay == 'disabled' && playInPlay == 'disabled') {
          socket.emit('discard', '3')
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
        } else if (rearrangeInPlay == 'disabled' && discardInPlay == 'disabled') {
          socket.emit('play', '3')
          $('#hints button').attr("disabled", false)
          $('#discard').attr("disabled", false)
          $('#play').attr("disabled", false)
          $('#player1 #rearrange').attr("disabled", false)
        }
      }
    })

  })

  socket.on('statuses', function(statuses) {
    var statusHtml = 'Status</br>'
    statusHtml += '<span>&nbsp;Hints: '+ statuses.hints +'&nbsp;</span>'
    statusHtml += '<span>&nbsp;Lives: '+ statuses.lives +'&nbsp;</span>'
    statusHtml += '<span>&nbsp;Cards: '+ statuses.cardsLeft +'&nbsp;</span>'
    $('#status').html(statusHtml)  
    if (statuses.hints == 0) {
      $('#hints button').attr('disabled', true)
    }
  })

  socket.on('played', function(played) {
    $('#playedArea').html('Played Cards</br>');

    for(var i=0; i<played.length; i++) {
      $('#playedArea').html(function() {
        var html = $('#playedArea').html();
        html += '&nbsp;' + getCardSvg(played[i]) + '&nbsp;';
        return html;
      })
    }
  })
  
  socket.on('discarded', function(discarded) {
    discarded.sort(function(a, b) {
      var diff = a.color - b.color;
      if (diff == 0) {
        return a.num - b.num;
      }
      return diff;
    });

    $('#discardArea').html('Discarded Cards</br>');
    for(var i=0; i<discarded.length; i++) {
      $('#discardArea').html(function() {
        var html = $('#discardArea').html();
        html += '&nbsp;' + getCardSvg(discarded[i]) + '&nbsp;';
        return html;
      })
    }
  })

  
</script>
</body>

</html>
